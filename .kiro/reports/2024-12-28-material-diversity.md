# 物質の多様性導入後のシミュレーション検証

## 日時
2024年12月28日（日）

## 概要

公理19-21（物質の多様性、質量、化学反応）を導入した後の100,000 tickシミュレーション結果を、導入前と比較・考察する。

## 検証結果

### 数値比較

| 項目 | 導入前 | 導入後 | 変化率 |
|------|--------|--------|--------|
| 最終エンティティ数 | 14 | 28 | +100% |
| 総エネルギー | 1,231 | 3,597 | +192% |
| アーティファクト数 | 413 | 32 | -92% |
| 平均年齢 | 54,414 | 65,920 | +21% |
| イベント数 | 1,289,645 | 2,312,042 | +79% |
| 実行時間 | 466秒 | 728秒 | +56% |

### 時系列推移（導入後）

| Tick | エンティティ | エネルギー | アーティファクト |
|------|-------------|-----------|-----------------|
| 10,000 | 16 | 1,251 | 21 |
| 20,000 | 19 | 2,010 | 28 |
| 30,000 | 22 | 2,058 | 13 |
| 40,000 | 28 | 3,283 | 24 |
| 50,000 | 26 | 3,218 | 28 |
| 60,000 | 31 | 3,191 | 23 |
| 70,000 | 27 | 3,296 | 29 |
| 80,000 | 29 | 2,934 | 26 |
| 90,000 | 26 | 3,114 | 24 |
| 100,000 | 28 | 3,597 | 32 |

## 考察

### 1. 人口増加の要因

**仮説**: 化学反応による「発熱反応」がエネルギー供給源として機能している。

- 反応テーブルでは、反応時に `-10 to +10` のエネルギー変化が発生
- 発熱反応（energyDelta > 0）が起きると、系全体のエネルギーが増加
- これは「外部エネルギー入力」に加えた第二のエネルギー源となる
- 結果として、より多くのエンティティを養える環境収容力が増加

**現世界との対応**: 
- 化学反応によるエネルギー放出は現実世界でも存在（燃焼、代謝など）
- ただし、現実では「エネルギー保存則」により系全体のエネルギーは増えない
- 本シミュレーションでは反応のエネルギー変化が「外部からの入力」として機能している

**課題**: 
- 発熱反応がエネルギー保存則を破っている可能性
- より厳密には、反応のエネルギー変化は「結合エネルギーの解放」として質量から変換されるべき

### 2. アーティファクト激減の要因

**仮説**: 化学反応がエンティティの行動パターンを変化させた。

- 相互作用時に化学反応が発生すると、両エンティティが消滅し新エンティティが生成
- これにより「相互作用→アーティファクト生成」の流れが中断される
- 反応確率が高いタイプ同士は、アーティファクトを作る前に反応してしまう

**別の仮説**: エネルギー配分の変化
- 化学反応処理にエネルギーが使われ、アーティファクト生成に回るエネルギーが減少
- ただし、総エネルギーは増加しているため、この仮説は弱い

**現世界との対応**:
- 「文明の発達」と「化学的活性」のトレードオフ
- 化学的に活発な環境では、安定した構造（アーティファクト）が維持されにくい

### 3. 長寿化の要因

**仮説**: タイプごとの「安定性」パラメータが寿命に影響。

- 各タイプには `stability` パラメータ（0.0-1.0）がある
- 安定性が高いタイプは、エントロピーによる劣化に強い
- 長期的に安定性の高いタイプが選択される（自然選択）

**仮説2**: 化学反応による「若返り」効果
- 反応で生成されるエンティティは age=0 から始まる
- 古いエンティティが反応で消滅し、新しいエンティティに置き換わる
- しかし、平均年齢は増加しているため、この効果は限定的

### 4. 計算コスト増加

- タイプ性質の参照、反応テーブルの検索・生成が追加
- 質量ベースの移動コスト計算が追加
- イベント数が79%増加（反応イベントの追加）

## 新たな仮説

### H6: 化学反応は「第二のエネルギー源」として機能する
- 発熱反応がエネルギーを系に注入
- これは設計上の問題かもしれない（エネルギー保存則違反）

### H7: 化学的活性と文明発達はトレードオフ
- 反応が活発な環境ではアーティファクト（情報の蓄積）が減少
- 安定した環境が文明発達の前提条件

### H8: タイプの自然選択が起きている
- 安定性・採取効率の高いタイプが生き残りやすい
- 長期的にタイプ分布が偏る可能性

## 重要な発見：相互作用と化学反応が発生していない

シミュレーションログを詳細に分析した結果、**interactionCount と reactionCount が全tick で 0** であることが判明した。

### 原因分析（修正済み）

**根本原因**: ノードの `entityIds` が更新されていなかった

- エンティティ生成時、移動時、死亡時にノードの `entityIds` を更新していなかった
- `perception.nearbyEntities` は `currentNode.entityIds` から取得するため、常に空だった
- 結果として、相互作用の対象が見つからず、相互作用が発生しなかった

**修正内容**:
1. `WorldGenerator.generateEntities`: エンティティ生成時にノードに登録
2. `Universe.processTransitArrivals`: 移動時に元ノードから削除、新ノードに追加
3. `Universe.processDeaths`: 死亡時にノードから削除
4. `Universe.executeReplicate`: 複製時に新エンティティをノードに追加
5. `Universe.executeReaction`: 化学反応時に反応物を削除、生成物を追加

**修正後の確認**:
- 10ノード、50エンティティ、10,000 tickのシミュレーションで確認
- `interactionCount`: 12, 7, 9, 10, 11... → 相互作用が発生
- `reactionCount`: 1, 0, 1, 0, 0... → 化学反応も発生

### 仮説の修正

**H6（化学反応は第二のエネルギー源）は再検証が必要**
- 以前のシミュレーションではバグにより化学反応が発生していなかった
- 修正後のシミュレーションで再検証する必要がある

## 今後の観察ポイント

1. **修正後の長期シミュレーション**: 化学反応の効果を再検証
2. **タイプ分布の時間変化**: 特定のタイプが優勢になるか
3. **相互作用と化学反応の頻度**: どの程度発生するか
4. **アーティファクト数への影響**: 化学反応がアーティファクト生成に与える影響

## 設計への示唆

### エネルギー保存則の厳密化
現在の実装では、化学反応の `energyDelta` が「無から有を生む」形になっている。より物理的に正確にするには：

```
反応前: E1 + E2 + (m1 + m2) * c
反応後: E_products + m_products * c
```

として、エネルギー・質量の総和を保存すべき。

### 反応確率の調整
現在の反応確率（0.1-0.6）が高すぎる可能性。アーティファクト生成とのバランスを取るため、反応確率を下げることを検討。
